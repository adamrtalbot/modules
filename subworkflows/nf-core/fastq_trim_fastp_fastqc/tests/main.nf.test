nextflow_workflow {

    name "Test Workflow FASTQ_TRIM_FASTP_FASTQC"
    script "subworkflows/nf-core/fastq_trim_fastp_fastqc/main.nf"
    workflow "FASTQ_TRIM_FASTP_FASTQC"
    tag "subworkflows/fastq_trim_fastp_fastqc"

    test("test_fastq_trim_fastp_fastqc_single_end") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            workflow {
                """
                Channel.fromPath(params.test_data['sarscov2']['illumina']['test_1_fastq_gz'], checkIfExists: true)
                    .flatten()
                    .map { it -> tuple( [ id: 'test' ], [ it ] ) }
                    .set { input_files }
                save_trimmed_fail = false
                save_merged       = false
                skip_fastqc       = false
                skip_fastp        = false

                input[0] = input_files
                input[1] = []
                input[2] = save_trimmed_fail
                input[3] = save_merged
                input[4] = skip_fastqc
                input[5] = skip_fastp
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.trace.succeeded().size() == 3
            assert snapshot(
                workflow.out.reads, 
                workflow.out.trim_json, 
                workflow.out.trim_reads_fail, 
                workflow.out.trim_reads_merged, 
            ).match()
            assert workflow.out.trim_json.size() == 1
            assert workflow.out.trim_html.size() == 1
            assert workflow.out.trim_log.size() == 1
            assert workflow.out.fastqc_raw_html.size() == 1
            assert workflow.out.fastqc_raw_zip.size() == 1
            assert workflow.out.fastqc_trim_html.size() == 1
            assert workflow.out.fastqc_trim_zip.size() == 1
            def actual = workflow.out.versions.collect { filepath -> "${path(filepath).getFileName}:md5,${path(filepath).md5}" }
            def expected = [
                "versions.yml:md5,2da05fb640ca6106be6412bd32e8003f",
                "versions.yml:md5,54e38ebe354c705a56c06a11c0ccf68e",
                "versions.yml:md5,712d34b9d3e3703d173d6422327e6f9e"
            ]
            assertContainsInAnyOrder(actual, expected)
        }

    }


    test("test_fastq_trim_fastp_fastqc_paired_end") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            workflow {
                """
                in_1 = Channel.fromPath(params.test_data['sarscov2']['illumina']['test_1_fastq_gz'], checkIfExists: true)
                in_2 = Channel.fromPath(params.test_data['sarscov2']['illumina']['test_2_fastq_gz'], checkIfExists: true)
                in_1.mix(in_2)
                    .collect()
                    .map { it -> tuple( [ id: 'test' ], it ) }
                    .set { input_files }
                save_trimmed_fail = false
                save_merged       = false
                skip_fastqc       = false
                skip_fastp        = false

                input[0] = input_files
                input[1] = []
                input[2] = save_trimmed_fail
                input[3] = save_merged
                input[4] = skip_fastqc
                input[5] = skip_fastp
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.trace.succeeded().size() == 3
            assert snapshot(
                workflow.out.reads, 
                workflow.out.trim_json, 
                workflow.out.trim_reads_fail, 
                workflow.out.trim_reads_merged, 
            ).match()
            assert workflow.out.trim_json.size() == 1
            assert workflow.out.trim_html.size() == 1
            assert workflow.out.trim_log.size() == 1
            assert workflow.out.fastqc_raw_html.size() == 1
            assert workflow.out.fastqc_raw_zip.size() == 1
            assert workflow.out.fastqc_trim_html.size() == 1
            assert workflow.out.fastqc_trim_zip.size() == 1
            assert workflow.out.fastqc_trim_zip.size() == 1
            def actual = workflow.out.versions.collect { filepath -> "${path(filepath).getFileName}:md5,${path(filepath).md5}" }
            def expected = [
                "versions.yml:md5,2da05fb640ca6106be6412bd32e8003f",
                "versions.yml:md5,54e38ebe354c705a56c06a11c0ccf68e",
                "versions.yml:md5,712d34b9d3e3703d173d6422327e6f9e"
            ]
            assertContainsInAnyOrder(actual, expected)
        }

    }


    test("test_fastq_trim_fastp_fastqc_interleaved") {

        when {
            params {
                // define parameters here. Example:
                // outdir = "tests/results"
            }
            workflow {
                """
                Channel.fromPath(params.test_data['sarscov2']['illumina']['test_1_fastq_gz'], checkIfExists: true)
                    .flatten()
                    .map { it -> tuple( [ id: 'test' ], it ) }
                    .set { input_files }
                save_trimmed_fail = false
                save_merged       = false
                skip_fastqc       = false
                skip_fastp        = false

                input[0] = input_files
                input[1] = []
                input[2] = save_trimmed_fail
                input[3] = save_merged
                input[4] = skip_fastqc
                input[5] = skip_fastp
                """
            }
        }

        then {
            assert workflow.success
            assert workflow.trace.succeeded().size() == 3
            assert snapshot(
                workflow.out.reads, 
                workflow.out.trim_json, 
                workflow.out.trim_reads_fail, 
                workflow.out.trim_reads_merged, 
            ).match()
            assert workflow.out.trim_json.size() == 1
            assert workflow.out.trim_html.size() == 1
            assert workflow.out.trim_log.size() == 1
            assert workflow.out.fastqc_raw_html.size() == 1
            assert workflow.out.fastqc_raw_zip.size() == 1
            assert workflow.out.fastqc_trim_html.size() == 1
            assert workflow.out.fastqc_trim_zip.size() == 1
            def actual = workflow.out.versions.collect { filepath -> "${path(filepath).getFileName}:md5,${path(filepath).md5}" }
            def expected = [
                "versions.yml:md5,2da05fb640ca6106be6412bd32e8003f",
                "versions.yml:md5,54e38ebe354c705a56c06a11c0ccf68e",
                "versions.yml:md5,712d34b9d3e3703d173d6422327e6f9e"
            ]
            assertContainsInAnyOrder(actual, expected)
        }

    }

}
